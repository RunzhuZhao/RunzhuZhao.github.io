---
layout: post
title: iOS-KVO实现原理与应用
categories: iOS
description: iOS系统知识笔记
keywords: iOS,KVO, 笔记
---

## KVO实现原理与应用
### KVO实现原理
*当为一个对象的属性添加观察者的时候，系统内部会派生一个当前对象类的子类`NSKVONotify_ClassName`，
然后将对象的isa指针指向子类`NSKVONotify_ClassName`。
*在子类`NSKVONotify_ClassName`中重写属性的`set`方法,在set方法中为成员变量赋值前后分别插入`willChangeValueForKey`、`didChangeValueForKey`方法。参考如下代码：
```
- (void)setName:(NSString *)name {
    [self willChangeValueForKey:@"name"];
    _name = name;
    [self didChangeValueForKey:@"name"];
}
```

```
@interface Person : NSObject
@property (nonatomic, copy) NSString *name;
@end
```

```
- (void)addObserverForPersonName {
    const char *classNameBefore = object_getClassName(self.person);
    NSLog(@"添加观察者前:%@", [NSString stringWithUTF8String:classNameBefore]);
    [self.person addObserver:self forKeyPath:@"name" options:NSKeyValueObservingOptionNew context:nil];
    const char *classNameAfter = object_getClassName(self.person);
    NSLog(@"添加观察者后:%@", [NSString stringWithUTF8String:classNameAfter]);
}

```
打印结果

<img width="282" alt="image" src="https://github.com/RunzhuZhao/RunzhuZhao.github.io/assets/70840468/d37c338c-d3de-4f0e-bff1-3bf76c2b59d0">


### KVO在开发中的应用
#### 注意事项
1. 当添加观察者后，在观察者准备销毁的时候需要将观察者移除。
2. iOS系统底层实现不允许移除一个不存在的观察者，所以开发中要避免重复移除操作
3. 不要使用对象的ISA指针进行类关系判断，因为ISA指针在对象有属性观察者的时候被修改。

[KVO苹果官方开发手册](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html?language=objc#//apple_ref/doc/uid/10000177i)   
